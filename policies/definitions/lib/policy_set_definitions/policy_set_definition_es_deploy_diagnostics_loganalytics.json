{
  "name": "Deploy-Diagnostics-LogAnalytics",
  "properties": {
    "description": "This policy set deploys the configurations of application Azure resources to forward diagnostic logs and metrics to an Azure Log Analytics workspace. See the list of policies of the services that are included ",
    "displayName": "Deploy Diagnostic Settings to Azure Services",
    "metadata": {
      "version": "1.1.0",
      "category": "Monitoring"
    },
    "parameters": {
      "ApplicationGatewayLogAnalyticsEffect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Deploy Diagnostic Settings for Application Gateway to Log Analytics workspace",
          "description": "Deploys the diagnostic settings for Application Gateway to stream to a Log Analytics workspace when any Application Gateway which is missing this diagnostic settings is created or updated. The Policy will set the diagnostic with all metrics and category enabled"
        }
      },
      "ExpressRouteLogAnalyticsEffect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Deploy Diagnostic Settings for ExpressRoute to Log Analytics workspace",
          "description": "Deploys the diagnostic settings for ExpressRoute to stream to a Log Analytics workspace when any ExpressRoute which is missing this diagnostic settings is created or updated. The Policy will set the diagnostic with all metrics and category enabled"
        }
      },
      "FirewallLogAnalyticsEffect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Deploy Diagnostic Settings for Firewall to Log Analytics workspace",
          "description": "Deploys the diagnostic settings for Firewall to stream to a Log Analytics workspace when any Firewall which is missing this diagnostic settings is created or updated. The Policy will set the diagnostic with all metrics and category enabled"
        }
      },
      "FrontDoorLogAnalyticsEffect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Deploy Diagnostic Settings for Front Door to Log Analytics workspace",
          "description": "Deploys the diagnostic settings for Front Door to stream to a Log Analytics workspace when any Front Door which is missing this diagnostic settings is created or updated. The Policy will set the diagnostic with all metrics and category enabled"
        }
      },
      "IotHubLogAnalyticsEffect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Deploy Diagnostic Settings for IoT Hub to Log Analytics workspace",
          "description": "Deploys the diagnostic settings for IoT Hub to stream to a Log Analytics workspace when any IoT Hub which is missing this diagnostic settings is created or updated. The Policy will set the diagnostic with all metrics and category enabled"
        }
      },
      "logAnalytics": {
        "metadata": {
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "displayName": "Log Analytics workspace",
          "strongType": "omsWorkspace"
        },
        "type": "String"
      },
      "VNetGWLogAnalyticsEffect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Deploy Diagnostic Settings for VPN Gateway to Log Analytics workspace",
          "description": "Deploys the diagnostic settings for VPN Gateway to stream to a Log Analytics workspace when any VPN Gateway which is missing this diagnostic settings is created or updated. The Policy will set the diagnostic with all metrics and category enabled."
        }
      },
      "profileName": { 
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "diagnosticSettingName": { 
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "categoryGroup": {
        "type": "String",
        "defaultValue": "allLogs",
        "metadata": {
          "displayName": "Category Group",
          "description": "Diagnostic category group - none, audit, or allLogs."
        }
      },
      "resourceLocationList": {
        "type": "Array",
        "metadata": {
          "displayName": "Resource Location List",
          "description": "Resource Location List to send logs to nearby Log Analytics. A single entry \"*\" selects all locations (default)."
        },
        "defaultValue": [
          "*"
        ]
    }
    },
    "policyDefinitions": [
      {
        "policyDefinitionReferenceId": "ApplicationGatewayDeployDiagnosticLogDeployLogAnalytics",
        "policyDefinitionId": "${targetManagementGroupResourceId}/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-ApplicationGateway",
        "parameters": {
          "logAnalytics": {
            "value": "[[parameters('logAnalytics')]"
          },
          "effect": {
            "value": "[[parameters('ApplicationGatewayLogAnalyticsEffect')]"
          },
          "profileName": {
            "value": "[[parameters('profileName')]"
          }
        },
        "groupNames": []
      },
      {
        "policyDefinitionReferenceId": "ExpressRouteDeployDiagnosticLogDeployLogAnalytics",
        "policyDefinitionId": "${targetManagementGroupResourceId}/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-ExpressRoute",
        "parameters": {
          "logAnalytics": {
            "value": "[[parameters('logAnalytics')]"
          },
          "effect": {
            "value": "[[parameters('ExpressRouteLogAnalyticsEffect')]"
          },
          "profileName": {
            "value": "[[parameters('profileName')]"
          }
        },
        "groupNames": []
      },
      {
        "policyDefinitionReferenceId": "FirewallDeployDiagnosticLogDeployLogAnalytics",
        "policyDefinitionId": "${targetManagementGroupResourceId}/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-Firewall",
        "parameters": {
          "logAnalytics": {
            "value": "[[parameters('logAnalytics')]"
          },
          "effect": {
            "value": "[[parameters('FirewallLogAnalyticsEffect')]"
          },
          "diagnosticSettingName": {
            "value": "[[parameters('diagnosticSettingName')]"
          }
        },
        "groupNames": []
      },
      {
        "policyDefinitionReferenceId": "FrontDoorDeployDiagnosticSettingsToLogAnalytics",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/6201aeb7-2b5c-4671-8ab4-5d3ba4d77f3b",
        "parameters": {
          "logAnalytics": {
            "value": "[[parameters('logAnalytics')]"
          },
          "effect": {
            "value": "[[parameters('FrontDoorLogAnalyticsEffect')]"
          },
          "diagnosticSettingName": {
            "value": "[[parameters('profileName')]"
          },
          "categoryGroup": {
            "value": "[[parameters('categoryGroup')]"
          },
          "resourceLocationList": {
            "value": "[[parameters('resourceLocationList')]"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "IotHubDeployDiagnosticLogDeployLogAnalytics",
        "policyDefinitionId": "${targetManagementGroupResourceId}/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-iotHub",
        "parameters": {
          "logAnalytics": {
            "value": "[[parameters('logAnalytics')]"
          },
          "effect": {
            "value": "[[parameters('IotHubLogAnalyticsEffect')]"
          },
          "profileName": {
            "value": "[[parameters('profileName')]"
          }
        },
        "groupNames": []
      },
      {
        "policyDefinitionReferenceId": "VNetGWDeployDiagnosticLogDeployLogAnalytics",
        "policyDefinitionId": "${targetManagementGroupResourceId}/providers/Microsoft.Authorization/policyDefinitions/Deploy-Diagnostics-VNetGW",
        "parameters": {
          "logAnalytics": {
            "value": "[[parameters('logAnalytics')]"
          },
          "effect": {
            "value": "[[parameters('VNetGWLogAnalyticsEffect')]"
          },
          "profileName": {
            "value": "[[parameters('profileName')]"
          }
        },
        "groupNames": []
      }
    ]
  },
  "scope": null,
  "type": "Microsoft.Authorization/policySetDefinitions"
}
